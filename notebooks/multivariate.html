

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Multivariate unfolding &mdash; PyUnfold  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Mathematical Derivations" href="../mathematics.html" />
    <link rel="prev" title="Smoothing unfolded distributions via spline regularization" href="regularization.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/simple@2x.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../why.html">Why PyUnfold?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../callbacks.html">Callbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">PyUnfold API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../advanced.html">Advanced Techniques</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="user_prior.html">Implementing a user-defined prior</a></li>
<li class="toctree-l2"><a class="reference internal" href="regularization.html">Smoothing via spline regularization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Multivariate unfolding via cause groups</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Example-dataset">Example dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Cause-Groups">Cause Groups</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Example—two-identical-cause-groups">Example—two identical cause groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#User-Priors-with-Groups">User Priors with Groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Regularization-with-Groups">Regularization with Groups</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Pitfalls-of-multivariate-unfolding">Pitfalls of multivariate unfolding</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mathematics.html">Mathematical Derivations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing PyUnfold</a></li>
</ul>
<p class="caption"><span class="caption-text">Useful links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/jrbourbeau/pyunfold">PyUnfold &#64; GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/pyunfold/">PyUnfold &#64; PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://anaconda.org/conda-forge/pyunfold">PyUnfold &#64; conda-forge</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/jrbourbeau/pyunfold/issues">Issue Tracker</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PyUnfold</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../advanced.html">Advanced Techniques</a> &raquo;</li>
        
      <li>Multivariate unfolding</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Multivariate-unfolding">
<h1>Multivariate unfolding<a class="headerlink" href="#Multivariate-unfolding" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyunfold</span> <span class="k">import</span> <span class="n">iterative_unfold</span>
<span class="kn">from</span> <span class="nn">pyunfold.callbacks</span> <span class="k">import</span> <span class="n">Logger</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">14.0</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;legend.fontsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.0</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="section" id="Example-dataset">
<h2>Example dataset<a class="headerlink" href="#Example-dataset" title="Permalink to this headline">¶</a></h2>
<p>We’ll generate the same example dataset that is used in the <a class="reference internal" href="tutorial.html"><span class="doc">Getting
Started tutorial</span></a>, i.e.&nbsp;a Gaussian sample that is
smeared by some noise.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># True distribution</span>
<span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span>
<span class="n">true_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">num_causes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">data_true</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">true_samples</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

<span class="c1"># Observed distribution</span>
<span class="n">random_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>
<span class="n">observed_samples</span> <span class="o">=</span> <span class="n">true_samples</span> <span class="o">+</span> <span class="n">random_noise</span>
<span class="n">data_observed</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">observed_samples</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="n">data_observed_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data_observed</span><span class="p">)</span>

<span class="c1"># Efficiencies</span>
<span class="n">efficiencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">data_observed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">efficiencies_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">efficiencies</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Response matrix</span>
<span class="n">response_hist</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">observed_samples</span><span class="p">,</span> <span class="n">true_samples</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="n">response_hist_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">response_hist</span><span class="p">)</span>

<span class="c1"># Normalized response</span>
<span class="n">column_sums</span> <span class="o">=</span> <span class="n">response_hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">normalization_factor</span> <span class="o">=</span> <span class="n">efficiencies</span> <span class="o">/</span> <span class="n">column_sums</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">response_hist</span> <span class="o">*</span> <span class="n">normalization_factor</span>
<span class="n">response_err</span> <span class="o">=</span> <span class="n">response_hist_err</span> <span class="o">*</span> <span class="n">normalization_factor</span>
</pre></div>
</div>
</div>
<p>We can see what the true and observed distributions look like for this
example dataset</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_true</span><span class="p">)),</span> <span class="n">data_true</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True distribution&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_observed</span><span class="p">)),</span> <span class="n">data_observed</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed distribution&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_6_0.png" src="../_images/notebooks_multivariate_6_0.png" />
</div>
</div>
<p>as well as the normalized response matrix</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$P(E_i|C_{\mu})$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Effect bins&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Normalized response matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_8_0.png" src="../_images/notebooks_multivariate_8_0.png" />
</div>
</div>
</div>
<div class="section" id="Cause-Groups">
<h2>Cause Groups<a class="headerlink" href="#Cause-Groups" title="Permalink to this headline">¶</a></h2>
<p>To illustrate the generalization to multivariate unfolding, we consider
a set of effects originating from two different <strong>cause types</strong> having
their own ranges. We can assign a new superscript <span class="math notranslate nohighlight">\(i\)</span> to denote
these types:</p>
<div class="math notranslate nohighlight">
\[C_{\mu}^{i} \text{ where } i \in [1,2]\]</div>
<p>and the subscript <span class="math notranslate nohighlight">\(\mu\)</span> runs over the respective number of causes
in each type <span class="math notranslate nohighlight">\(\, n_{C1}\)</span> and <span class="math notranslate nohighlight">\(\, n_{C2}\)</span>.</p>
<p>But since the PyUnfold doesn’t care how we label the bins, we can simply
redefine our cause index <span class="math notranslate nohighlight">\(\mu\)</span> to run over a larger index range.
Hence,</p>
<div class="math notranslate nohighlight">
\[C_{\mu}^i \rightarrow C_{\mu} \text{ where } \mu \in [1, \, n_{C1} + n_{C2}]\]</div>
<p>Thus, given a general multidimensional (<span class="math notranslate nohighlight">\(i&gt;1\)</span>) response matrix, we
can effectively <em>unroll</em> it onto a two dimensional array and still use
PyUnfold.</p>
<div class="section" id="Example—two-identical-cause-groups">
<h3>Example—two identical cause groups<a class="headerlink" href="#Example—two-identical-cause-groups" title="Permalink to this headline">¶</a></h3>
<p>Here we use two identical cause groups, simply copying our original
response matrix along the cause axis.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Response with two groups</span>
<span class="n">response_hist_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">response_hist</span><span class="p">,</span> <span class="n">response_hist</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">response_hist_groups_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">response_hist_groups</span><span class="p">)</span>

<span class="c1"># Efficiencies with two groups</span>
<span class="n">efficiencies_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">response_hist_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">efficiencies_groups_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">efficiencies_groups</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">num_causes</span> <span class="o">=</span> <span class="n">response_hist_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Scale by efficiency</span>
<span class="n">column_sums_groups</span> <span class="o">=</span> <span class="n">response_hist_groups</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">normalization_factor_groups</span> <span class="o">=</span> <span class="n">efficiencies_groups</span> <span class="o">/</span> <span class="n">column_sums_groups</span>

<span class="c1"># Response matrix with two groups</span>
<span class="n">response_groups</span> <span class="o">=</span> <span class="n">response_hist_groups</span> <span class="o">*</span> <span class="n">normalization_factor_groups</span>
<span class="n">response_groups_err</span> <span class="o">=</span> <span class="n">response_hist_groups_err</span> <span class="o">*</span> <span class="n">normalization_factor_groups</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">response_groups</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$P(E_i|C_{\mu})$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Effect bins&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Normalized response matrix - 2 groups&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_12_0.png" src="../_images/notebooks_multivariate_12_0.png" />
</div>
</div>
<p>Now the two (identical) cause groups are <em>unrolled</em> clearly along the
abscissa. Since the unfolding method is cause agnostic, we can perform
an unfolding, remembering that we’ve kept the same observed data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_observed</span><span class="p">,</span>
                                           <span class="n">data_err</span><span class="o">=</span><span class="n">data_observed_err</span><span class="p">,</span>
                                           <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                           <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                           <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                           <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                           <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                           <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                           <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.0730, ts_stopping = 0.01
Iteration 2: ts = 0.0030, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Unfolding&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_15_0.png" src="../_images/notebooks_multivariate_15_0.png" />
</div>
</div>
<p>So the result is two equal copies of the causes. This makes sense
because in our example we have simply considered two <em>identical</em> groups
of causes, so they should contribute identically to producing the
measured effects.</p>
</div>
<div class="section" id="User-Priors-with-Groups">
<h3>User Priors with Groups<a class="headerlink" href="#User-Priors-with-Groups" title="Permalink to this headline">¶</a></h3>
<p>What if we want to use the a user-defined prior (e.g.&nbsp;Jeffreys’ prior)?
In this case, we have to setup the <code class="docutils literal notranslate"><span class="pre">prior</span></code> input to contain the priors
we want for each group.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyunfold.priors</span> <span class="k">import</span> <span class="n">jeffreys_prior</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Cause limits</span>
<span class="n">cause_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">num_causes</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Setup group Jeffreys&#39; prior</span>
<span class="n">prior_jeff_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jeffreys_prior</span><span class="p">(</span><span class="n">cause_lim</span><span class="p">),</span> <span class="n">jeffreys_prior</span><span class="p">(</span><span class="n">cause_lim</span><span class="p">)])</span>
<span class="n">prior_jeff_groups</span> <span class="o">=</span> <span class="n">prior_jeff_groups</span> <span class="o">/</span> <span class="n">prior_jeff_groups</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">prior_jeff_groups</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;$P(C_{\mu})$&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Jeffreys Priors&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_21_0.png" src="../_images/notebooks_multivariate_21_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups_jeff</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_observed</span><span class="p">,</span>
                                                <span class="n">data_err</span><span class="o">=</span><span class="n">data_observed_err</span><span class="p">,</span>
                                                <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                                <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                                <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                                <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                                <span class="n">prior</span><span class="o">=</span><span class="n">prior_jeff_groups</span><span class="p">,</span>
                                                <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                                <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                                <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.3615, ts_stopping = 0.01
Iteration 2: ts = 0.0085, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups_jeff</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
             <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups_jeff</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
             <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
             <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
             <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Unfolding - Jeffreys Prior&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_23_0.png" src="../_images/notebooks_multivariate_23_0.png" />
</div>
</div>
<p>Again, we recover two copies of the causes.</p>
</div>
<div class="section" id="Regularization-with-Groups">
<h3>Regularization with Groups<a class="headerlink" href="#Regularization-with-Groups" title="Permalink to this headline">¶</a></h3>
<p>In general, groups of causes do not share continuity of the cause axis.
In the above examples, the cause arrays are stacked next to each other,
so while the unfolding method doesn’t care about the cause definitions,
the default regularization smooths over <strong>all</strong> cause bins without
regard to types.</p>
<p>PyUnfold implements group regularization, where smoothing of the
unfolded distributions is performed only within designated cause types
(i.e.&nbsp;each cause type is regularized independently). This is done by
providing the <code class="docutils literal notranslate"><span class="pre">SplineRegularizer</span></code> function a <code class="docutils literal notranslate"><span class="pre">groups</span></code> list, defining
a group identification for each cause bin.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyunfold.callbacks</span> <span class="k">import</span> <span class="n">SplineRegularizer</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Here we know we have two copies of the causes</span>
<span class="n">n_c1</span> <span class="o">=</span> <span class="n">response_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">n_c2</span> <span class="o">=</span> <span class="n">response_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n_c1</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n_c2</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Group definitions: </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Group definitions:
[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">group_reg</span> <span class="o">=</span> <span class="n">SplineRegularizer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups_reg</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_observed</span><span class="p">,</span>
                                               <span class="n">data_err</span><span class="o">=</span><span class="n">data_observed_err</span><span class="p">,</span>
                                               <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                               <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                               <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                               <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                               <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                               <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                               <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">(),</span> <span class="n">group_reg</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.0730, ts_stopping = 0.01
Iteration 2: ts = 0.0030, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups_reg</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups_reg</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Unfolding - regularized&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_30_0.png" src="../_images/notebooks_multivariate_30_0.png" />
</div>
</div>
<p>Again, for this simple example, everything looks fine.</p>
<p>However, if we consider a more complicated example, we’ll see the power
of these implementations.</p>
</div>
</div>
<div class="section" id="Pitfalls-of-multivariate-unfolding">
<h2>Pitfalls of multivariate unfolding<a class="headerlink" href="#Pitfalls-of-multivariate-unfolding" title="Permalink to this headline">¶</a></h2>
<p>Let’s generate some more example data by keeping our two-type response
matrix.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># True distribution</span>
<span class="n">group_data_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">n_c1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_c2</span><span class="p">)))</span>

<span class="c1"># Observed data, no smearing</span>
<span class="n">group_data_observed</span> <span class="o">=</span> <span class="n">response_groups</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">group_data_true</span><span class="p">)</span>
<span class="n">group_data_observed_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">group_data_observed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax_1</span><span class="p">,</span> <span class="n">ax_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="c1"># Cause distribution</span>
<span class="n">ax_1</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">group_data_true</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True distribution&#39;</span><span class="p">)</span>
<span class="n">ax_1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cause Distribution&#39;</span><span class="p">)</span>

<span class="c1"># Effects distribution</span>
<span class="n">ax_2</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_data_observed</span><span class="p">)),</span> <span class="n">group_data_observed</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed distribution&#39;</span><span class="p">)</span>
<span class="n">ax_2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Effect bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Effects Distribution&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_34_0.png" src="../_images/notebooks_multivariate_34_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Setup all cause spline</span>
<span class="n">spline_reg</span> <span class="o">=</span> <span class="n">SplineRegularizer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">5e6</span><span class="p">)</span>

<span class="c1"># Setup group spline</span>
<span class="n">group_reg</span> <span class="o">=</span> <span class="n">SplineRegularizer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups_default_reg</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">group_data_observed</span><span class="p">,</span>
                                                       <span class="n">data_err</span><span class="o">=</span><span class="n">group_data_observed_err</span><span class="p">,</span>
                                                       <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                                       <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                                       <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                                       <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                                       <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                                       <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                                       <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">(),</span> <span class="n">spline_reg</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.0919, ts_stopping = 0.01
Iteration 2: ts = 0.0479, ts_stopping = 0.01
Iteration 3: ts = 0.0246, ts_stopping = 0.01
Iteration 4: ts = 0.0125, ts_stopping = 0.01
Iteration 5: ts = 0.0064, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups_group_reg</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">group_data_observed</span><span class="p">,</span>
                                                     <span class="n">data_err</span><span class="o">=</span><span class="n">group_data_observed_err</span><span class="p">,</span>
                                                     <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                                     <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                                     <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                                     <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                                     <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                                     <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                                     <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">(),</span> <span class="n">group_reg</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.1070, ts_stopping = 0.01
Iteration 2: ts = 0.0011, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">group_data_true</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Distribution&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups_group_reg</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups_group_reg</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Group Regularization&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups_default_reg</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups_default_reg</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Default Regularization&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Unfolding&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_38_0.png" src="../_images/notebooks_multivariate_38_0.png" />
</div>
</div>
<p>So, what’s going on here? There are actually two problems here.</p>
<ol class="arabic simple">
<li>It’s clear that the default regularization tries to connect the two
cause groups in a smooth manner.</li>
<li>And while the group regularization is doing its best to smooth each
group individually, it’s clear we are getting copies again. This is
due to the <strong>prior</strong> assumption that all causes have equal
probabilities.</li>
</ol>
<p>Let’s redo this by giving a strong preference in the prior to one of the
groups.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Flat prior to each group, but one has stronger preference.</span>
<span class="n">flat_pref_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_c1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_c1</span><span class="p">)))</span>
<span class="n">flat_pref_prior</span> <span class="o">=</span> <span class="n">flat_pref_prior</span> <span class="o">/</span> <span class="n">flat_pref_prior</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups_group_reg_prior</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">group_data_observed</span><span class="p">,</span>
                                                           <span class="n">data_err</span><span class="o">=</span><span class="n">group_data_observed_err</span><span class="p">,</span>
                                                           <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                                           <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                                           <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                                           <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                                           <span class="n">prior</span><span class="o">=</span><span class="n">flat_pref_prior</span><span class="p">,</span>
                                                           <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                                           <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                                           <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">(),</span> <span class="n">group_reg</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.1900, ts_stopping = 0.01
Iteration 2: ts = 0.0018, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">group_data_true</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Distribution&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups_group_reg_prior</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups_group_reg_prior</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Group Regularization&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Unfolding&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_42_0.png" src="../_images/notebooks_multivariate_42_0.png" />
</div>
</div>
<p>Now we’re starting to get something that looks right.</p>
<p>However, we are still using two identical copies of the response matrix
which means that we’re considering the same sets of causes, just split
up into two groups.</p>
<p>This also demonstrates another potential issue with doing group
unfolding: if there is high degree of degeneracy between the respective
response functions, then the unfolding results will be strongly
dependent on intial priors.</p>
<p>The solution to this is to ensure that the cause group response matrices
have different structure, for example by having different normalizations
(efficiency). We demonstrate this below to finish.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Response with two groups having different structures</span>
<span class="n">n_c1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_hist</span><span class="p">)</span>
<span class="n">n_c2</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">response_hist_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">response_hist</span><span class="p">,</span> <span class="n">response_hist</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">n_c2</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">response_hist_groups_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">response_hist_groups</span><span class="p">)</span>

<span class="c1"># Efficiencies with two groups</span>
<span class="n">efficiencies_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">response_hist_groups</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">efficiencies_groups_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">efficiencies_groups</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="c1"># Make the second group 25% efficient</span>
<span class="n">efficiencies_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_c1</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1</span>
<span class="n">efficiencies_groups</span><span class="p">[</span><span class="n">n_c1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.25</span>
<span class="n">efficiencies_groups_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">efficiencies_groups</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Scale by efficiency</span>
<span class="n">column_sums_groups</span> <span class="o">=</span> <span class="n">response_hist_groups</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">normalization_factor_groups</span> <span class="o">=</span> <span class="n">efficiencies_groups</span> <span class="o">/</span> <span class="n">column_sums_groups</span>

<span class="c1"># Response matrix with two groups</span>
<span class="n">response_groups</span> <span class="o">=</span> <span class="n">response_hist_groups</span> <span class="o">*</span> <span class="n">normalization_factor_groups</span>
<span class="n">response_groups_err</span> <span class="o">=</span> <span class="n">response_hist_groups_err</span> <span class="o">*</span> <span class="n">normalization_factor_groups</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n_c1</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n_c2</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Group definitions: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Group definitions: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">group_reg</span> <span class="o">=</span> <span class="n">SplineRegularizer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">response_groups</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$P(E_i|C_{\mu})$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Effect bins&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Normalized response matrix - groups&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_47_0.png" src="../_images/notebooks_multivariate_47_0.png" />
</div>
</div>
<p>Regenerate some example data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># True distribution</span>
<span class="n">group_data_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">n_c1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_c2</span><span class="p">)))</span>
<span class="n">num_causes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_data_true</span><span class="p">)</span>

<span class="c1"># Observed data, no smearing</span>
<span class="n">group_data_observed</span> <span class="o">=</span> <span class="n">response_groups</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">group_data_true</span><span class="p">)</span>
<span class="n">group_data_observed_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">group_data_observed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">unfolded_results_groups_group_reg</span> <span class="o">=</span> <span class="n">iterative_unfold</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">group_data_observed</span><span class="p">,</span>
                                                     <span class="n">data_err</span><span class="o">=</span><span class="n">group_data_observed_err</span><span class="p">,</span>
                                                     <span class="n">response</span><span class="o">=</span><span class="n">response_groups</span><span class="p">,</span>
                                                     <span class="n">response_err</span><span class="o">=</span><span class="n">response_groups_err</span><span class="p">,</span>
                                                     <span class="n">efficiencies</span><span class="o">=</span><span class="n">efficiencies_groups</span><span class="p">,</span>
                                                     <span class="n">efficiencies_err</span><span class="o">=</span><span class="n">efficiencies_groups_err</span><span class="p">,</span>
                                                     <span class="n">ts</span><span class="o">=</span><span class="s1">&#39;ks&#39;</span><span class="p">,</span>
                                                     <span class="n">ts_stopping</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                                     <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">Logger</span><span class="p">(),</span> <span class="n">group_reg</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Iteration 1: ts = 0.1548, ts_stopping = 0.01
Iteration 2: ts = 0.0021, ts_stopping = 0.01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Extend range of bins</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">group_data_true</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Distribution&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_causes</span><span class="p">),</span> <span class="n">unfolded_results_groups_group_reg</span><span class="p">[</span><span class="s1">&#39;unfolded&#39;</span><span class="p">],</span>
            <span class="n">yerr</span><span class="o">=</span><span class="n">unfolded_results_groups_group_reg</span><span class="p">[</span><span class="s1">&#39;sys_err&#39;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Group Regularization&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Cause bins&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span>
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group Unfolding&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_multivariate_51_0.png" src="../_images/notebooks_multivariate_51_0.png" />
</div>
</div>
<p>Since the groups are differentiable in terms of response structure and
efficiencies, we obtain reasonable unfolding results even using the
default uniform prior across all bins!</p>
<p>This simply illustrates the need for proper understanding of one’s data.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, James Bourbeau, Zigfried Hampel-Arias.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>